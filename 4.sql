-- Creating STUDENT table
CREATE TABLE STUDENT(
    USN VARCHAR(10) PRIMARY KEY,
    SNAME VARCHAR(20),
    ADDRESS VARCHAR(50),
    PHONE VARCHAR(15),
    GENDER CHAR
);

-- Inserting sample values into STUDENT table
INSERT INTO STUDENT VALUES ('1RN13CS020', 'AKSHAY', 'BELAGAVI', '8877881122', 'M');
INSERT INTO STUDENT VALUES ('1RN13CS062', 'SANDHYA', 'BENGALURU', '7722829912', 'F');
INSERT INTO STUDENT VALUES ('1RN13CS091', 'TEESHA', 'BENGALURU', '7712312312', 'F');
INSERT INTO STUDENT VALUES ('1RN14CS010', 'ABHAY', 'BENGALURU', '9900211201', 'M');
INSERT INTO STUDENT VALUES ('1RN14CS032', 'BHASKAR', 'BENGALURU', '9923211099', 'M');

-- Creating SEMSEC table
CREATE TABLE SEMSEC(
    SSID VARCHAR(8) PRIMARY KEY,
    SEM INT,
    SEC CHAR
);

-- Inserting sample values into SEMSEC table
INSERT INTO SEMSEC VALUES ('CSE8A', 8, 'A');
INSERT INTO SEMSEC VALUES ('CSE8B', 8, 'B');
INSERT INTO SEMSEC VALUES ('CSE7A', 7, 'A');
INSERT INTO SEMSEC VALUES ('CSE7B', 7, 'B');
INSERT INTO SEMSEC VALUES ('CSE6A', 6, 'A');

-- Creating CLASS table
CREATE TABLE CLASS(
    USN VARCHAR(10),
    SSID VARCHAR(8),
    FOREIGN KEY (USN) REFERENCES STUDENT(USN) ON DELETE CASCADE,
    FOREIGN KEY (SSID) REFERENCES SEMSEC(SSID) ON DELETE CASCADE,
    PRIMARY KEY (USN, SSID)
);

-- Inserting sample values into CLASS table
INSERT INTO CLASS VALUES ('1RN13CS020', 'CSE8A');
INSERT INTO CLASS VALUES ('1RN13CS062', 'CSE8A');
INSERT INTO CLASS VALUES ('1RN13CS091', 'CSE8B');
INSERT INTO CLASS VALUES ('1RN14CS010', 'CSE7A');
INSERT INTO CLASS VALUES ('1RN14CS032', 'CSE7B');

-- Creating SUBJECT table
CREATE TABLE SUBJECT(
    SUBCODE VARCHAR(20) PRIMARY KEY,
    TITLE VARCHAR(20),
    SEM INT,
    CREDITS INT
);

-- Inserting sample values into SUBJECT table
INSERT INTO SUBJECT VALUES ('10CS81', 'ACA', 8, 4);
INSERT INTO SUBJECT VALUES ('10CS82', 'SSM', 8, 4);
INSERT INTO SUBJECT VALUES ('10CS71', 'OOAD', 7, 4);
INSERT INTO SUBJECT VALUES ('10CS72', 'ECS', 7, 4);
INSERT INTO SUBJECT VALUES ('10CS61', 'DBMS', 6, 4);

-- Creating IAMARKS table
CREATE TABLE IAMARKS(
    USN VARCHAR(10),
    SUBCODE VARCHAR(20),
    SSID VARCHAR(8),
    TEST1 INT,
    TEST2 INT,
    TEST3 INT,
    FINALIA DECIMAL(5,2),
    FOREIGN KEY (USN) REFERENCES STUDENT(USN) ON DELETE CASCADE,
    FOREIGN KEY (SUBCODE) REFERENCES SUBJECT(SUBCODE) ON DELETE CASCADE,
    FOREIGN KEY (SSID) REFERENCES SEMSEC(SSID) ON DELETE CASCADE,
    PRIMARY KEY (USN, SUBCODE, SSID)
);

-- Inserting sample values into IAMARKS table
INSERT INTO IAMARKS VALUES ('1RN13CS020', '10CS81', 'CSE8A', 15, 16, 18, NULL);
INSERT INTO IAMARKS VALUES ('1RN13CS062', '10CS82', 'CSE8A', 12, 19, 14, NULL);
INSERT INTO IAMARKS VALUES ('1RN13CS091', '10CS81', 'CSE8B', 19, 15, 20, NULL);
INSERT INTO IAMARKS VALUES ('1RN14CS010', '10CS71', 'CSE7A', 20, 16, 19, NULL);
INSERT INTO IAMARKS VALUES ('1RN14CS032', '10CS72', 'CSE7B', 15, 15, 12, NULL);

-- Query 1: Fetch students from semester 4, section C
SELECT S.*, SS.SEM, SS.SEC
FROM STUDENT S, SEMSEC SS, CLASS C
WHERE S.USN = C.USN
AND SS.SSID = C.SSID
AND SS.SEM = 4
AND SS.SEC = 'C';

-- Query 2: Count students by gender for each SEMSEC
SELECT SS.SEM, SS.SEC, S.GENDER, COUNT(S.GENDER) AS COUNT 
FROM STUDENT S, SEMSEC SS, CLASS C
WHERE S.USN = C.USN AND SS.SSID = C.SSID
GROUP BY SS.SEM, SS.SEC, S.GENDER
ORDER BY SEM;

-- Query 3: Create a view for Test 1 marks of a student
CREATE VIEW STU_TEST1_MARKS_VIEW AS
SELECT TEST1, SUBCODE
FROM IAMARKS
WHERE USN = '1RN13CS091';

-- Query 4: Stored procedure to calculate average IA marks
SET SQL_SAFE_UPDATES = 0;
  UPDATE IAMARKS
  SET FINALIA = (TEST1 + TEST2 + TEST3 - LEAST(TEST1, TEST2, TEST3)) / 2.0;
SET SQL_SAFE_UPDATES = 1;

-- Query 5: Categorizing students based on IA marks
SELECT S.USN, S.SNAME, S.ADDRESS, S.PHONE, S.GENDER,
(CASE
    WHEN IA.FINALIA BETWEEN 17 AND 20 THEN 'OUTSTANDING'
    WHEN IA.FINALIA BETWEEN 12 AND 16 THEN 'AVERAGE'
    ELSE 'WEAK'
END) AS CAT
FROM STUDENT S, SEMSEC SS, IAMARKS IA, SUBJECT SUB
WHERE S.USN = IA.USN
AND SS.SSID = IA.SSID
AND SUB.SUBCODE = IA.SUBCODE
AND SUB.SEM = 8;
